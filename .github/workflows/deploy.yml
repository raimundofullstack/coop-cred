name: Deploy AWS ECS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to ECR
        run: |
          docker build -t coop-cred .
          docker tag coop-cred:latest ${{ steps.login-ecr.outputs.registry }}/coop-cred:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/coop-cred:latest

      - name: Generate ECS task definition
        run: |
          cat > ecs-task-def.json <<EOF
          {
            "family": "coop-cred-task",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "256",
            "memory": "512",
            "containerDefinitions": [
              {
                "name": "mongo",
                "image": "mongo:6",
                "essential": true,
                "portMappings": [
                  { "containerPort": 27017, "protocol": "tcp" }
                ],
                "environment": [
                  { "name": "MONGO_INITDB_DATABASE", "value": "coopcred" }
                ],
                "mountPoints": [
                  {
                    "sourceVolume": "mongo_data",
                    "containerPath": "/data/db"
                  }
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/coop-cred",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "mongo",
                    "awslogs-create-group": "true"
                  }
                },
                "healthCheck": {
                  "command": [
                    "CMD-SHELL",
                    "mongosh --quiet --eval 'db.runCommand({ ping: 1 })' || exit 1"
                  ],
                  "interval": 10,
                  "timeout": 5,
                  "retries": 5,
                  "startPeriod": 15
                },
              },
              {
                "name": "coop-cred",
                "image": "629143592813.dkr.ecr.us-east-1.amazonaws.com/coop-cred:latest",
                "essential": true,
                "portMappings": [
                  { "containerPort": 3000, "protocol": "tcp" }
                ],
                "environment": [
                  { "name": "PORT", "value": "3000" },
                  { "name": "NODE_ENV", "value": "production" },
                  { "name": "JWT_SECRET", "value": "${{ secrets.JWT_SECRET }}" },
                  { "name": "SENTRY_DSN", "value": "${{ secrets.SENTRY_DSN }}" },
                  { "name": "MONGO_URL", "value": "mongodb://mongo:27017/coopcred" }
                ],
                "dependsOn": [
                  {
                    "containerName": "mongo",
                    "condition": "HEALTHY"
                  }
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/coop-cred",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "ecs",
                    "awslogs-create-group": "true"
                  }
                }
              }
            ],
            "volumes": [
              {
                "name": "mongo_data",
                "efsVolumeConfiguration": {
                  "fileSystemId": "fs-06403275f2f7d1ff3",
                  "rootDirectory": "/"
                }
              }
            ],
            "executionRoleArn": "arn:aws:iam::629143592813:role/ecsTaskExecutionRole"
          }
          EOF

      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ecs-task-def.json
          service: coop-cred-service
          cluster: coop-cred-cluster
          wait-for-service-stability: true
